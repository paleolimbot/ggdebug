
#' Benchmark ggplot2 plots
#'
#' @param exprs A [rlang::quos()] of ggplot specs like that generated by
#'   [ggbench_standards()].
#' @param ... Passed to [bench::mark]
#' @param device A device wraper that takes `filename` (see [withr::with_png])
#'   as its first argument.
#' @param filename A filename, possibly using [sprintf()] syntax to render more than
#'   one plot.
#'
#' @return A [bench::mark()] object.
#' @export
#'
#' @examples
#' ggbench()
#'
ggbench <- function(exprs = ggbench_standards(1), ..., device = withr::with_png,
                    filename = tempfile(fileext = "Rplot%03d")) {
  # for the time being, assume all the expressions have the same env
  env <- rlang::get_env(exprs[[1]])

  expr_spec <- purrr::map(exprs, rlang::get_expr)
  spec <- bench::mark(exprs = expr_spec,  ..., check = FALSE, env = env)
  spec$stage <- "spec"

  expr_build <- purrr::map(expr_spec, function(expr) rlang::call2("ggplot_build", expr, .ns = "ggplot2"))
  build <- bench::mark(exprs = expr_build, ..., check = FALSE, env = env)
  build$stage <- "build"

  expr_draw <- purrr::map(expr_build, function(expr) rlang::call2("ggplot_gtable", expr, .ns = "ggplot2"))
  draw <- bench::mark(exprs = expr_draw, ..., check = FALSE, env = env)
  draw$stage <- "draw"

  expr_render <- purrr::map(expr_draw, function(expr) rlang::call2("grid.draw", expr, .ns = "grid"))
  expr_dev <- purrr::map(expr_render, function(expr) rlang::call2(device, filename, expr))
  render <- bench::mark(exprs = expr_dev, ..., check = FALSE, env = env)
  render$stage <- "render"

  # assemble output
  out <- rbind(spec, build, draw, render)
  out$stage <- factor(out$stage, levels = c("spec", "build", "draw", "render"))
  out <- out[c("stage", setdiff(names(out), "stage"))]
  class(out) <- c("ggbench", "bench_mark", "tbl_df", "tbl", "data.frame")
  out
}

#' Standard list of ggplot benchmarks
#'
#' @param which A subset of the standards, or `NULL` for everything
#'
#' @return A named [rlang::quos()] of plot expressions
#' @export
#'
#' @examples
#' ggbench_standards()
#'
ggbench_standards <- function(which = 1) {

  usa <- ggplot2::map_data("usa")
  states <- ggplot2::map_data("state")

  nc <- sf::read_sf(system.file("shape/nc.shp", package = "sf"))
  nc_whole <- sf::st_union(nc)

  # there's probably a more elegant way to deal with this
  # but it's nice to be able to pass the CMD check and not attach
  # ggplot2 by default
  mpg <- ggplot2::mpg
  diamonds <- ggplot2::diamonds
  ggplot <- ggplot2::ggplot
  aes <- ggplot2::aes
  geom_point <- ggplot2::geom_point
  geom_histogram <- ggplot2::geom_histogram
  geom_polygon <- ggplot2::geom_polygon
  geom_sf <- ggplot2::geom_sf
  geom_smooth <- ggplot2::geom_smooth
  scale_x_log10 <- ggplot2::scale_x_log10
  scale_x_continuous <- ggplot2::scale_x_continuous
  coord_fixed <- ggplot2::coord_fixed
  facet_grid <- ggplot2::facet_grid
  theme <- ggplot2::theme
  vars <- ggplot2::vars

  standards <- rlang::quos(
    basic = ggplot(mpg, aes(class, hwy)) + geom_point(),
    lg_sctr = ggplot(diamonds, aes(carat, price)) +
      geom_point(),
    sm_sctr = ggplot(diamonds[1:1000, ], aes(carat, price)) +
      geom_point(),
    trans = ggplot(diamonds, aes(carat, price)) + geom_point() +
      scale_x_log10(),
    many_axis = ggplot(diamonds, aes(carat, price)) +
      geom_point() +
      scale_x_continuous(breaks = seq(0, 5, .25)),
    no_lgd = ggplot(diamonds, aes(carat, price, colour = cut)) +
      geom_point() +
      theme(legend.position = "none"),
    sm_lgd_d = ggplot(diamonds, aes(carat, price, colour = cut)) +
      geom_point(),
    lg_lgd_d = ggplot(diamonds, aes(carat, price, colour = clarity)) +
      geom_point(),
    lgd_c = ggplot(diamonds, aes(carat, price, colour = depth)) +
      geom_point(),
    fct_5 = ggplot(diamonds, aes(carat, price)) + geom_point() +
      facet_grid(vars(cut)),
    fct_35 = ggplot(diamonds, aes(carat, price)) + geom_point() +
      facet_grid(vars(color), vars(cut)),
    lyr2 = ggplot(diamonds, aes(carat, price)) +
      geom_point() +
      geom_smooth(aes(colour = "lm"), method = "lm", se = FALSE),
    lyr3 = ggplot(diamonds, aes(carat, price)) +
      geom_point() +
      geom_smooth(aes(colour = "loess"), method = "loess", se = FALSE) +
      geom_smooth(aes(colour = "lm"), method = "lm", se = FALSE),
    hist = ggplot(diamonds, aes(x = price, fill = cut)) +
      geom_histogram(binwidth = 1000),
    hist_dg = ggplot(diamonds, aes(x = price, fill = cut)) +
      geom_histogram(position = "dodge", binwidth = 1000),
    hist_mny_bns = ggplot(diamonds, aes(x = price, fill = cut)) +
      geom_histogram(binwidth = 100),
    maps_us = ggplot(data = usa) +
      geom_polygon(aes(x = long, y = lat, group = group)) +
      coord_fixed(1.3),
    maps_sts = ggplot(data = states) +
      geom_polygon(aes(x = long, y = lat, group = group)) +
      coord_fixed(1.3),
    sf_many = ggplot(data = nc_whole) + geom_sf(),
    sf_one = ggplot(data = nc) + geom_sf()
  )

  if (is.null(which)) {
    standards
  } else {
    standards[which]
  }
}

# all the variables in the aes mapping
utils::globalVariables(c("long", "lat", "price", "carat", "depth", "hwy", "clarity", "group", "color"))
